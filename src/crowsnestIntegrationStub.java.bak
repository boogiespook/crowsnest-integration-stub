
//usr/bin/env jbang "$0" "$@" ; exit $?
//JAVA 17
//JAVAC_OPTIONS -parameters
//DEPS io.quarkus.platform:quarkus-bom:2.16.2.Final@pom
//DEPS io.quarkus:quarkus-picocli
//DEPS io.quarkus:quarkus-jdbc-postgresql
//DEPS com.googlecode.json-simple:json-simple:1.1.1
import picocli.CommandLine;

import java.net.*;
import java.io.*;
import java.sql.*;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import java.util.Map;
import java.util.Set;
import java.util.Properties;
//quarkus.kubernetes-config.secrets=postgresql

@Command(name = "Greeting", mixinStandardHelpOptions = true)
public class crowsnestIntegrationStub implements Runnable {

    @CommandLine.Option(names = {"--hash"}, description = "Hash for integration")
    String integrationHash;
//    System.out.printf("Entry Hash: %s\n", hash);

//    String query = "SELECT * from integrations WHERE integration_id = ?";
    String query = "SELECT * from integrations WHERE hash = 'RX6B4'";


    //@Parameters(paramLabel = "<dbUsername>", defaultValue = "telescope", description = "Db username")
    //String userName;
//    String userName = System.getenv("PG_USER");
    String userName = "postgres";

    //@Parameters(paramLabel = "<dbPassword>", defaultValue = "quarkus", description = "Db password")
    //String password;
    //String password = System.getenv("PG_PASSWORD");
    String password = "qwas1234";

    //@Parameters(paramLabel = "<dbUrl>", defaultValue = "jdbc:postgresql://postgresql:5432/telescope", description = "Db URL")
    //String url;
    //String url = System.getenv("PG_DB");
    String url = "jdbc:postgresql://localhost:5432/crowsnest";
    @Option(names = { "-v",
            "--verbose" }, description = "Verbose mode. Helpful for troubleshooting. Multiple -v options increase the verbosity.")
    private boolean verbose;

    Integer integration_id;
    Integer capability_id = 0;
    Integer success_criteria;
    Integer success, failure = 0;
    Integer flag_id = 1;
    String endpoint;

    /**
     * Update the capability table with the new flag_id (1 = red, 2 = green)
     * 
     * @return the number of affected rows
     */
    public int setCapabilityWithFlag() {

        String query = "UPDATE capability "
                + "SET flag_id = ? "
                + "WHERE id = ?";

        int affectedrows = 0;
        try (Connection conn = DriverManager.getConnection(url, userName, password)) {

            PreparedStatement statement = conn.prepareStatement(query);
            statement.setInt(1, flag_id);
            statement.setInt(2, capability_id);
            affectedrows = statement.executeUpdate();

        } catch (SQLException ex) {
            System.out.println(ex.getMessage());
        }
        return affectedrows;
    }

    /**
     * Update the integrations table with last_update
     * 
     * @return the number of affected rows
     */
    public int setIntegrationLastUpdate() {
        String query = "UPDATE integrations "
                + "SET last_update = Now() "
                + "WHERE integration_id = ?";

        int affectedrows = 0;

        try (Connection conn = DriverManager.getConnection(url, userName, password)) {

            PreparedStatement statement = conn.prepareStatement(query);
            statement.setInt(1, integration_id);

            affectedrows = statement.executeUpdate();

        } catch (SQLException ex) {
            System.out.println(ex.getMessage());
        }
        return affectedrows;
    }

    /**
     * Update the flag depending the score.
     * 
     * @param StringBuilder responseData
     * @throws ParseException
     */
    public void setFlagDependingScore(StringBuilder responseData) throws ParseException {

        success = 0;
        failure = 0;
//        int responseResult = 0;
//        JSONParser parser = new JSONParser();
//        System.out.printf("Response: %s\n", responseData.toString());
        int responseResult = Integer.valueOf(responseData.toString());
        if (responseResult == success_criteria) {
            success++;
            flag_id = 2;
        }

//        if (verbose) {
            System.out.printf("flag id: %s\n", flag_id);
            System.out.printf("Result: %s\n", responseResult);
            System.out.printf("Success criteria: %s\n", success);
//        }
    }

    /**
     * Retrieve data from database to process.
     * 
     */
    public void processData() {

        try (Connection conn = DriverManager.getConnection(url, userName, password)) {

            PreparedStatement statement = conn.prepareStatement(query);
            ResultSet rs = statement.executeQuery();
            {
                while (rs.next()) {
                    integration_id = rs.getInt("integration_id");
                    capability_id = rs.getInt("capability_id");
                    success_criteria = rs.getInt("success_criteria");
                    endpoint = rs.getString("url");
                }

                    System.out.printf("success_criteria: %s\n", success_criteria);

                if (endpoint != null) {

                    @SuppressWarnings("deprecation")
                    URL url = new URL(endpoint);
                    System.out.printf("Remote URL: %s\n", url);
                    HttpURLConnection con = (HttpURLConnection) url.openConnection();
                    con.setRequestMethod("GET");
                    con.setRequestProperty("Content-Type", "application/json");
                    con.setRequestProperty("Authorization", "Bearer ".concat(endpoint));
                    con.setRequestProperty("Accept", "application/json");

                    try (BufferedReader br = new BufferedReader(
                            new InputStreamReader(con.getInputStream(), "utf-8"))) {
                        StringBuilder response = new StringBuilder();
                        String responseLine = null;
                        while ((responseLine = br.readLine()) != null) {
                            response.append(responseLine.trim());
                        }
                        br.close();
                        setFlagDependingScore(response);
                    }
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
//        System.out.println("ARG: " + args[0]);
        System.out.printf("Running compliance check for CrowsNest integration \n");

        processData();

        if (capability_id != 0) {
            setCapabilityWithFlag();
            setIntegrationLastUpdate();
                    System.out.printf("Compliance flag updated to: %s\n", flag_id);
        }
    }
}
